{% extends 'base.html' %}
{% load static %}

 <!-- Override default page title -->
 {% block title%}
The Blog: Home
 {% endblock %}    
 <head> 
  <!-- Remove underline in links -->
  <style>a{TEXT-DECORATION:none}</style> 
</head>
<body>
{% block post_list %}

<!-- Button trigger modal -->
<!-- Button trigger modal -->
<div class="d-grid">
  <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#searchModal" onclick="clean_search()">
    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
      <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
    </svg>  
    Search 
  </button>


  
</div>



<!-- Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" name="search">
        <button class="btn btn-outline-success" type="button" onclick="submit_search()">Search</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="search_result">
        Search post
      </div>


    </div>
  </div>
</div>


<div class="dropdown filter" id="post-filter">
  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" id="dropdown-filter" type="button" data-toggle="dropdown" aria-expanded="false" onclick="toggle_filter_dropdown()">
    Filter
  </button>

  <ul class="dropdown-menu">
    <li><a class="dropdown-item active" id="filter-all" onclick="select_filter(this)">All</a></li>
    <li><a class="dropdown-item" id="filter-unread" onclick="select_filter(this)">Unread</a></li>
    <li><a class="dropdown-item" id="filter-unanswered" onclick="select_filter(this)">Unanswered</a></li>
    <li><a class="dropdown-item" id="filter-unresolved" onclick="select_filter(this)">Unresolved</a></li>
    <li><a class="dropdown-item" id="filter-endorsed_post" onclick="select_filter(this)">Endorsed Post</a></li>
    <li><a class="dropdown-item" id="filter-endorsed_comment" onclick="select_filter(this)">Endorsed Comment</a></li>
    <li><a class="dropdown-item" id="filter-private" onclick="select_filter(this)">Private</a></li>
    <!-- <li><a class="dropdown-item" id="filter-public" onclick="select_filter(this)">Public</a></li> -->
    <!-- <li><a class="dropdown-item" id="filter-staff" onclick="select_filter(this)">Staff</a></li> -->
    <li><a class="dropdown-item" id="filter-mine" onclick="select_filter(this)">Mine</a></li>
  </ul>
</div>


<div class="list-group overflow-auto h-100" id="list-group">
  
  {% for key, value in post_dict.items %}
  <span class="border">
    <div class="p-2 bg-light text-dark">
      <strong>{{key}}</strong>
    </div>
  </span>
    {% for post in value %}
    <div class="{{post.category}}" id="post-{{post.id}}" post-status="{{post.read.all.count}} {{post.comments.count}} {{post.solved_by_comment}} {{post.endorsed}} {{post.has_endorsed_comment}} {{post.author.id}}">
      <a class="list-group-item list-group-item-action post-list" id="{{post.pk}}" onclick="iframe_ctl(this)">
        <div class="d-flex w-100 justify-content-between">
          {{ post.title }}
          <!-- <small>{{ post.edit_date|date:"Y/m/d g:i a" }}</small> -->
          <small>{{ post.edit_date|timesince }}</small>
  
        </div>
        <!-- <p class="mb-1">Some placeholder content in a paragraph.</p> -->
  
        <small>{{ post.author.first_name }} {{ post.author.last_name }} #{{ post.category }}</small>
        
        <br>
        {% if post.is_pin %}
        <span class="badge rounded-pill text-bg-info">Pined</span>
        {% endif %}
        {% if not user in post.read.all %}
        <span class="badge rounded-pill text-bg-warning" id="unread_{{post.pk}}">Unread</span>
        {% endif %}
        {% if post.solved_by_comment == 0 %}
        <span class="badge rounded-pill text-bg-dark">?</span>
        {% else %}
        <span class="badge rounded-pill text-bg-success">!</span>
        {% endif %}
        
  
  
      </a>
      </div>
  
        
    {% endfor %}
  {% endfor %}
  
  

</div>  

<script>
  // $("#post_detail_iframe").attr("src", "{% url 'index_page' %}")


  // initialize
  localStorage.setItem('activeItemID', "");
  function toggle_filter_dropdown(){
    $("#dropdown-filter").dropdown("toggle");
  }
  function iframe_ctl(obj) {
    history.pushState({},'',obj.id);
    // alert("http://127.0.0.1:8000/article/"+obj.id);
    $("#post_detail_iframe").attr("src", "{% url 'article_detail' 'id' %}".replace("id",obj.id))
    // $(".article-detail-container").load("http://127.0.0.1:8000/article/"+obj.id)

    $(".list-group-item.list-group-item-action.post-list").attr("class", "list-group-item list-group-item-action post-list inactive")
    $(obj).attr("class", "list-group-item list-group-item-action post-list active")
    localStorage.setItem('activeItemID', obj.id);
    $("#unread_"+obj.id).attr('style', 'display:none;'); 
    }
    function select_filter(obj){
      var cat = 'all';
      if($("#category-list").find('.active')['length'] == 1){
        cat = $("#category-list").find('.active').attr('id').split('-')[1];
      }

      $("#dropdown-filter").dropdown("toggle");

      // if clicked item is not activated
      if($("#"+obj.id).hasClass("active") == false){
        $('.dropdown-item').removeClass("active")
        $("#"+obj.id).addClass("active")
        if(obj.id == "filter-all"){
          $("#dropdown-filter").text("Filter")
          $("#dropdown-filter").removeClass("btn-primary").addClass("btn-outline-secondary")
        }
        else{
          $("#dropdown-filter").text($("#"+obj.id).text())
          $("#dropdown-filter").removeClass("btn-outline-secondary").addClass("btn-primary")
        }

        
        $.ajax({

              type: "GET",
              url: "{% url 'post_list' current_course_id 'filter' 'cat' %}".replace("filter", obj.id.split("-")[1]).replace('cat', cat),
              dataType: "html", 
              success: function(jqXHR, textStatus, errorThrown){
                $('#list-group').html(jqXHR);
              }
            });
      }
      else {
        $('.dropdown-item').removeClass("active")
        $("#filter-all").addClass("active")
        $("#dropdown-filter").text("Filter")
        $("#dropdown-filter").removeClass("btn-primary").addClass("btn-outline-secondary")
        $.ajax({
          type: "GET",
          url: "{% url 'post_list' current_course_id 'all' 'cat' %}".replace('cat', cat),
          dataType: "html", 
          success: function(jqXHR, textStatus, errorThrown){
            $('#list-group').html(jqXHR);
          }
          });
      }

    }
    function submit_search(){
      
      $.ajax({
            url: "{% url 'search' current_course_id %}",
            type: "POST",
            dataType: "html",
            data: {csrfmiddlewaretoken: '{{ csrf_token }}', search: $('input[name="search"]').val() },
            success: function(jqXHR, textStatus, errorThrown){
                console.log(jqXHR);
                $('#search_result').html(jqXHR);
            }
        })      
    }
    function clean_search(){
      $('#search_result').html("");
      $('input[name="search"]').val('');
    }
    function load_search_dest(obj){
      $('#searchModal').modal('toggle');
      history.pushState({},'',obj.id);
      $("#post_detail_iframe").attr("src", "{% url 'article_detail' 'id' %}".replace("id",obj.id))
      $(".list-group-item.list-group-item-action.post-list").attr("class", "list-group-item list-group-item-action post-list inactive")
      $(obj).attr("class", "list-group-item list-group-item-action post-list active")
      localStorage.setItem('activeItemID', obj.id);
      $("#unread_"+obj.id).attr('style', 'display:none;'); 
    }
  </script>



{% endblock %}




{% block content %}


<iframe src="" class="col-sm-12" style="min-height: 92vh;" id="post_detail_iframe" onload="load_iframe()"></iframe>
<!-- <div class="article-detail-container" style="max-height: 92vh;overflow-y:auto"> -->


<script>
  console.log("{{iframe_src}}")
  if("{{iframe_src}}" == "index_page"){
    document.getElementById("post_detail_iframe").src = "{% url 'index_page' %}"
  }
  else{
    document.getElementById("post_detail_iframe").src = "{% url 'article_detail' 'id' %}".replace("id","{{iframe_src}}")
  }
  
</script>
{% endblock %}




</body>

